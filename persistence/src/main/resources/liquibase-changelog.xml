<!--
    Copyright (c) 2015 Development Gateway, Inc and others.

    All rights reserved. This program and the accompanying materials
    are made available under the terms of the MIT License (MIT)
    which accompanies this distribution, and is available at
    https://opensource.org/licenses/MIT

    Contributors:
    Development Gateway - initial API and implementation
-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="add-default-group" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="group1"/>
            <column name="DTYPE" value="Group"/>
        </insert>
    </changeSet>

    <changeSet id="add-default-roles" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="ROLE"/>
        </preConditions>
        <insert tableName="ROLE">
            <column name="ID" value="1"/>
            <column name="AUTHORITY" value="ROLE_USER"/>
        </insert>
        <insert tableName="ROLE">
            <column name="ID" value="2"/>
            <column name="AUTHORITY" value="ROLE_ADMIN"/>
        </insert>
        <insert tableName="ROLE">
            <column name="ID" value="3"/>
            <column name="AUTHORITY" value="ROLE_VALIDATOR"/>
        </insert>
    </changeSet>

    <changeSet id="7" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="PERSON_ROLES"/>
            <tableExists tableName="ROLE"/>
            <tableExists tableName="PERSON"/>
        </preConditions>
        <sqlFile path="Person.sql"/>
    </changeSet>

    <changeSet id="8" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="PERSON_ROLES"/>
            <tableExists tableName="ROLE"/>
            <tableExists tableName="PERSON"/>
        </preConditions>
        <sqlFile path="Person_roles.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-14" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Office of the Governor"/>
            <column name="CODE" value="D1"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Public Service Board"/>
            <column name="CODE" value="D2"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Makueni County Service (County Secretary)"/>
            <column name="CODE" value="D3"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL"
                    value="Devolution, County Administration, Participatory Development and Public Service"/>
            <column name="CODE" value="D4"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Finance and Social Economic Planning"/>
            <column name="CODE" value="D5"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Agriculture, Irrigation, Livestock and Fisheries Development"/>
            <column name="CODE" value="D6"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Water, Sanitation, Environment and Climate Change"/>
            <column name="CODE" value="D7"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Education, Youth, Sports and ICT"/>
            <column name="CODE" value="D8"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Health Services"/>
            <column name="CODE" value="D9"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Lands, Mining, Housing, Physical Planning and Urban Development"/>
            <column name="CODE" value="D10"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Roads, Transport, Energy and Public Works"/>
            <column name="CODE" value="D11"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Trade, Industry, Marketing, Tourism and Co-operative Development"/>
            <column name="CODE" value="D12"/>
            <column name="DTYPE" value="Department"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Gender, Children, Culture and Social Services"/>
            <column name="CODE" value="D13"/>
            <column name="DTYPE" value="Department"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-13" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Direct"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Open tender national"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="RF proposal"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="RFQ"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Restricted tender"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Special permitted"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Low value procurement"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Open tender International"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-17" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Youth"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Women"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="PWD"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Citizen Contractor"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Margin of Preference for Local Contractor"/>
            <column name="DTYPE" value="TargetGroup"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-35" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Development"/>
            <column name="DTYPE" value="ChargeAccount"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Recurrent"/>
            <column name="DTYPE" value="ChargeAccount"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-34" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Tender Form and Price schedule"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Schedule of Requirements"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Details of Cover"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Conditions of the Contract"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Special Conditions of Contract"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Procuring Entity Notification of Award"/>
            <column name="DTYPE" value="ContractDocumentType"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-37" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <sqlFile path="Items.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-117" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <sqlFile path="Metadata1.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-117-staff" author="gmutuhu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <sqlFile path="Metadata2.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-181" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Kaiti"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Kibwezi East"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Kibwezi West"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Kilome"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Makueni"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>

        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Mbooni"/>
            <column name="DTYPE" value="Subcounty"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-180" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
            <columnExists tableName="category" columnName="subcounty_id"/>
        </preConditions>
        <sqlFile path="Wards.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-177-1" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="tender_item"/>
            <tableExists tableName="tender_item_aud"/>
            <columnExists tableName="tender_item" columnName="quantity"/>
        </preConditions>
        <sql>alter table tender_item alter column quantity type double precision</sql>
        <sql>alter table tender_item_aud alter column quantity type double precision</sql>
    </changeSet>

    <changeSet id="OCMAKU-177-2" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="plan_item"/>
            <tableExists tableName="plan_item_aud"/>
            <columnExists tableName="plan_item" columnName="quantity"/>
        </preConditions>
        <sql>alter table plan_item alter column quantity type double precision</sql>
        <sql>alter table plan_item_aud alter column quantity type double precision</sql>
    </changeSet>

    <changeSet id="OCMAKU-177-3" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="purchase_item"/>
            <tableExists tableName="purchase_item_aud"/>
            <columnExists tableName="purchase_item" columnName="quantity"/>
        </preConditions>
        <sql>alter table purchase_item alter column quantity type double precision</sql>
        <sql>alter table purchase_item_aud alter column quantity type double precision</sql>
    </changeSet>

    <changeSet id="OCMAKU-333" author="idobre">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="person_departments"/>
        </preConditions>
        <sql>
            insert into person_departments (select id, department_id from person where department_id is not null);
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-382-1" author="mpostelnicu">
        <sql>
            ALTER TABLE public.purchase_requisition RENAME TO tender_process;
            ALTER TABLE public.purchase_requisition_aud RENAME TO tender_process_aud;
            ALTER TABLE public.purchase_requisition_form_docs RENAME TO tender_process_form_docs;
            ALTER TABLE public.purchase_requisition_status_comments RENAME TO tender_process_status_comments;
            ALTER TABLE public.purchase_requisition_purchase_item_aud RENAME TO tender_process_purchase_item_aud;
            ALTER TABLE public.tender RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.tender_quotation_evaluation RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.professional_opinion RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.award_notification RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.award_acceptance RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.contract RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.tender_process_status_comments RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.tender_process_form_docs RENAME purchase_requisition_id TO tender_process_id;
            ALTER TABLE public.purchase_item RENAME TO old_purchase_item;
            ALTER TABLE public.purchase_item_aud RENAME TO old_purchase_item_aud;
            DROP INDEX "idx4crx1on2q7qknriounxm5p330";
            DROP INDEX "idxjv3kypsec7o8b1juvyk2dj9mn";
            DROP INDEX "idxsfo7avbdcooxih398oabhbdau";
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-382-2" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="purch_requisition"/>
        </preConditions>
        <sql>
            insert into purch_requisition (id, "index", charge_account_id, created_by, created_date, last_modified_by,
            last_modified_date,
            parent_id, request_approval_date, requested_by_id, approved_date)
            (select nextval('hibernate_sequence'),0, t.charge_account_id, t.created_by, t.created_date,
            t.last_modified_by,
            t.last_modified_date, t.id, t.request_approval_date, t.requested_by_id, t.approved_date from tender_process
            t);
            insert into purch_requisition_form_docs (purch_requisition_id, form_docs_id)
            (select pr.id, tp.form_docs_id from tender_process_form_docs tp, purch_requisition pr where pr.parent_id =
            tp.tender_process_id);
            delete from tender_process_form_docs;
            insert into purchase_item (id, created_by, created_date, last_modified_by, last_modified_date, amount,
            description, quantity,
            parent_id, plan_item_id, index)
            (select o.id, o.created_by, o.created_date, o.last_modified_by, o.last_modified_date,
            o.amount, o.description, o.quantity, pr.id , o.plan_item_id, o."index"
            from old_purchase_item o, tender_process p, purch_requisition pr where o.parent_id=p.id
            and pr.parent_id = p.id);
            alter table tender_item DROP CONSTRAINT "fkl61vasyq7qrwegdguaqqrt97v";
            drop table old_purchase_item;
        </sql>
    </changeSet>


    <changeSet id="OCMAKU-387-1" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="professional_opinion_item"/>
            <tableExists tableName="professional_opinion_item_form_docs"/>
        </preConditions>
        <sql>
            insert into professional_opinion_item (id, "index", approved_date, awardee_id, created_by, created_date,
            last_modified_by, last_modified_date, parent_id, professional_opinion_date, recommended_award_amount)
            (select nextval('hibernate_sequence'), 0, approved_date, awardee_id, created_by, created_date,
            last_modified_by, last_modified_date, id, professional_opinion_date, recommended_award_amount from
            professional_opinion);
            insert into professional_opinion_item_form_docs (form_docs_id, professional_opinion_item_id)
            (select d.form_docs_id, pi.id from professional_opinion_form_docs d, professional_opinion_item pi
            where pi.parent_id=d.professional_opinion_id);
            delete from professional_opinion_form_docs;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-387-2" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="award_notification_item"/>
            <tableExists tableName="award_notification_item_form_docs"/>
        </preConditions>
        <sql>
            INSERT INTO award_notification_item(
            id, created_by, created_date, last_modified_by, last_modified_date, approved_date, acknowledgement_days,
            award_date, award_value, parent_id, awardee_id, "index")
            (select nextval('hibernate_sequence'), created_by, created_date,
            last_modified_by, last_modified_date, approved_date, acknowledgement_days, award_date, award_value, id,
            awardee_id, 0 from award_notification);
            INSERT INTO award_notification_item_form_docs(award_notification_item_id, form_docs_id)
            (select pi.id, d.form_docs_id from award_notification_form_docs d, award_notification_item pi where
            pi.parent_id=d.award_notification_id);
            delete from award_notification_form_docs;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-387-3" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="award_acceptance_item"/>
            <tableExists tableName="award_acceptance_item_form_docs"/>
        </preConditions>
        <sql>
            insert into award_acceptance_item (id, "index", acceptance_date, accepted_award_value, approved_date,
            awardee_id, created_by, created_date,
            last_modified_by, last_modified_date, parent_id)
            (select nextval('hibernate_sequence'), 0, acceptance_date, accepted_award_value, approved_date, awardee_id,
            created_by, created_date, last_modified_by,last_modified_date, id
            from award_acceptance);
            INSERT INTO award_acceptance_item_form_docs (award_acceptance_item_id, form_docs_id)
            (select pi.id, d.form_docs_id from award_acceptance_form_docs d, award_acceptance_item pi where
            pi.parent_id=d.award_acceptance_id);
            delete from award_acceptance_form_docs;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-387-4" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Accepted"/>
            <column name="DTYPE" value="SupplierResponse"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Rejected"/>
            <column name="DTYPE" value="SupplierResponse"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-387-5" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
            <tableExists tableName="award_acceptance_item"/>
        </preConditions>
        <sql>
            update award_acceptance_item set supplier_response_id =
            (select id from category where dtype='SupplierResponse' and label='Accepted');
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-411" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="tender"/>
        </preConditions>
        <sql>
            update tender set tender_link = 'https://tenders.go.ke' where id in (16897, 19365, 16881);
            update tender set tender_link = 'https://makueni.go.ke' where id in (16884, 16908);
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-430" author="mpostelnicu">
        <sql>
            CREATE TEMPORARY TABLE draft_tender_process_ids as (
            select tp.id from fiscal_year fy, procurement_plan pp, project p, tender_process tp, tender t
            where fy.id = pp.fiscal_year_id and p.procurement_plan_id=pp.id and tp.project_id=p.id and
            t.tender_process_id=tp.id
            and (t.invitation_date &gt; fy.end_date OR t.invitation_date &lt; fy.start_date)
            UNION
            select t.tender_process_id from tender t, tender tt where t.id!=tt.id and t.tender_title=tt.tender_title
            UNION
            select t.tender_process_id from tender t where t.id not in (select parent_id from tender_item)
            UNION
            select tender_process_id from tender_quotation_evaluation where id not in(select parent_id from bid));
            update tender_process set status='DRAFT' where id in (select id from draft_tender_process_ids);
            update tender set status='DRAFT' where tender_process_id in (select id from draft_tender_process_ids);
            update tender_quotation_evaluation set status='DRAFT' where tender_process_id in (select id from
            draft_tender_process_ids);
            update professional_opinion set status='DRAFT' where tender_process_id in (select id from
            draft_tender_process_ids);
            update award_notification set status='DRAFT' where tender_process_id in (select id from
            draft_tender_process_ids);
            update award_acceptance set status='DRAFT' where tender_process_id in (select id from
            draft_tender_process_ids);
            update contract set status='DRAFT' where tender_process_id in (select id from draft_tender_process_ids);
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-448" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Framework Agreement"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Two-stage Tendering"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Design Competition"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Force Account"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Electronic Reverse Auction"/>
            <column name="DTYPE" value="ProcurementMethod"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-229-wards-coords" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
            <columnExists tableName="CATEGORY" columnName="location_point"/>
        </preConditions>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.71667, -1.66667)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kalawa"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.65, -1.73333)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kako/Waia"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.58333, -1.61667)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kisau/Kiteta"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.5058, -1.66214)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kithungo"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.4658, -1.62222)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Mbooni"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.406443, -1.579237)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Tulimani"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.621548, -1.788768)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Makueni Head Quarters"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.5, -1.96667)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Mbitini"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.63333, -1.75)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Wote"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.87557, -2.04882)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kitise/Kithuki"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.81667, -1.83333)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Mavindini"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.73188, -1.91375)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kathonzweni"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.68333, -1.9)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Muvau"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.53333, -1.9)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Nzaui/Kalamba"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.383333, -1.91667)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kasikeu"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.36667, -1.9)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Mukaa"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.7038, -2.35948)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kiima Kiu/Kalanzoni"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.48796, -2.01417)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Emali/Mulala"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.61667, -2.01667)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Nguu/Masumba"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.89608, -2.37458)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Nguumo"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(38.025153, -2.346991)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kikumbulyu South"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(38.002477, -2.182311)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kikumbulyu North"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.81867, -2.27808)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Makindu"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(38.077433, -2.64911)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Ivingoni"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(38.04281, -2.47248)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Thange"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(38.16687, -2.68987)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Mtito Andei"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(38.04776, -2.48161)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Masongaleni"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.53333, -1.73333)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Ukia"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.42988, -1.86946)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Ilima"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.36667, -1.8)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kilungu"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.34356, -1.72331)"/>
            <where>dtype='Ward' and label=:value</where>
            <whereParams>
                <param value="Kee"/>
            </whereParams>
        </update>
    </changeSet>
    <changeSet id="OCMAKU-229-subcounties-coords" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
            <columnExists tableName="CATEGORY" columnName="location_point"/>
        </preConditions>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.5, -1.66667)"/>
            <where>dtype='Subcounty' and label=:value</where>
            <whereParams>
                <param value="Mbooni"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.872, -2.222)"/>
            <where>dtype='Subcounty' and label=:value</where>
            <whereParams>
                <param value="Makueni"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.31667, -1.81667)"/>
            <where>dtype='Subcounty' and label=:value</where>
            <whereParams>
                <param value="Kilome"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.973119, -2.409593)"/>
            <where>dtype='Subcounty' and label=:value</where>
            <whereParams>
                <param value="Kibwezi West"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.957368, -2.412616)"/>
            <where>dtype='Subcounty' and label=:value</where>
            <whereParams>
                <param value="Kibwezi East"/>
            </whereParams>
        </update>
        <update tableName="category">
            <column name="location_point" valueComputed="ST_Point(37.475992, -1.763179)"/>
            <where>dtype='Subcounty' and label=:value</where>
            <whereParams>
                <param value="Kaiti"/>
            </whereParams>
        </update>
    </changeSet>

    <changeSet id="OCMAKU-465" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="BID"/>
        </preConditions>
        <update tableName="BID">
            <column name="quoted_amount" value="null"/>
            <where>quoted_amount=0</where>
        </update>
    </changeSet>

    <changeSet id="OCMAKU-510" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="ROLE"/>
        </preConditions>

        <update tableName="ROLE">
            <column name="AUTHORITY" value="ROLE_PROCUREMENT_USER"/>
            <where>AUTHORITY='ROLE_USER'</where>
        </update>

        <update tableName="ROLE">
            <column name="AUTHORITY" value="ROLE_PROCUREMENT_VALIDATOR"/>
            <where>AUTHORITY='ROLE_VALIDATOR'</where>
        </update>

    </changeSet>


    <changeSet id="OCMAKU-511" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="ROLE"/>
        </preConditions>
        <insert tableName="ROLE">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="AUTHORITY" value="ROLE_IMPLEMENTATION_USER"/>
        </insert>
        <insert tableName="ROLE">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="AUTHORITY" value="ROLE_PMC_VALIDATOR"/>
        </insert>
        <insert tableName="ROLE">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="AUTHORITY" value="ROLE_TECH_ADMIN_VALIDATOR"/>
        </insert>
        <insert tableName="ROLE">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="AUTHORITY" value="ROLE_ME_PAYMENT_VALIDATOR"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-522-PMCStatus" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="At Risk"/>
            <column name="DTYPE" value="PMCStatus"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="On Track"/>
            <column name="DTYPE" value="PMCStatus"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Off Track"/>
            <column name="DTYPE" value="PMCStatus"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-522-ProjectClosureHandover" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Test"/>
            <column name="DTYPE" value="ProjectClosureHandover"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-521-MEStatus" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Completed not in use"/>
            <column name="DTYPE" value="MEStatus"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Complete in use"/>
            <column name="DTYPE" value="MEStatus"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Ongoing"/>
            <column name="DTYPE" value="MEStatus"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Not started"/>
            <column name="DTYPE" value="MEStatus"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Stalled"/>
            <column name="DTYPE" value="MEStatus"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Delayed"/>
            <column name="DTYPE" value="MEStatus"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-583-ProjectClosureHandover" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <update tableName="CATEGORY">
            <column name="LABEL" value="School management"/>
            <where>dtype='ProjectClosureHandover' and label=:value</where>
            <whereParams>
                <param value="Test"/>
            </whereParams>
        </update>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Hospital Management committees"/>
            <column name="DTYPE" value="ProjectClosureHandover"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Project Sustainability committees"/>
            <column name="DTYPE" value="ProjectClosureHandover"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-583-SubWards" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
            <columnExists tableName="CATEGORY" columnName="ward_id"/>
        </preConditions>
        <sqlFile path="SubWards.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-596" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="COVID-19"/>
            <column name="DTYPE" value="ProcurementMethodRationale"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-590-unit-codes" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
            <columnExists tableName="CATEGORY" columnName="code"/>
        </preConditions>
        <update tableName="category">
            <column name="code" value="LO"/>
            <column name="label" value="lot"/>
            <where>dtype='Unit' and label='Lots'</where>
        </update>
        <update tableName="category">
            <column name="code" value="BE"/>
            <column name="label" value="bundle"/>
            <where>dtype='Unit' and label='Bundle'</where>
        </update>
        <update tableName="category">
            <column name="code" value="EA"/>
            <column name="label" value="each"/>
            <where>dtype='Unit' and label='Each'</where>
        </update>
        <update tableName="category">
            <column name="code" value="PA"/>
            <column name="label" value="packet"/>
            <where>dtype='Unit' and label='Packet'</where>
        </update>
        <update tableName="category">
            <column name="code" value="RM"/>
            <column name="label" value="ream"/>
            <where>dtype='Unit' and label='Realm'</where>
        </update>
    </changeSet>

    <changeSet id="OCMAKU-590-change-unit-codes" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
            <columnExists tableName="CATEGORY" columnName="code"/>
        </preConditions>

        <sql>update plan_item set unit_of_issue_id = (select id from category where dtype='Unit' and code='EA')
            where unit_of_issue_id in (select id from category where dtype='Unit' and label in ('Road', 'Building'))
        </sql>
        <delete tableName="category">
            <where>dtype='Unit' and label in ('Road', 'Building')</where>
        </delete>
    </changeSet>

    <changeSet id="OCMAKU-651-rename-proc-methods" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <update tableName="CATEGORY">
            <column name="label" value="Direct Procurement"/>
            <where>dtype='ProcurementMethod' and label='Direct'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="label" value="Open Tender - National"/>
            <where>dtype='ProcurementMethod' and label='Open tender national'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="label" value="Request for Proposal"/>
            <where>dtype='ProcurementMethod' and label='RF proposal'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="label" value="Request for Quotation"/>
            <where>dtype='ProcurementMethod' and label='RFQ'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="label" value="Restricted Tender"/>
            <where>dtype='ProcurementMethod' and label='Restricted tender'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="label" value="Specially Permitted"/>
            <where>dtype='ProcurementMethod' and label='Special permitted'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="label" value="Low Value Procurement"/>
            <where>dtype='ProcurementMethod' and label='Low value procurement'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="label" value="Open Tender - International"/>
            <where>dtype='ProcurementMethod' and label='Open tender International'</where>
        </update>
    </changeSet>


    <changeSet id="OCMAKU-685-project-cabinet-papers" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="PROJECT_CABINET_PAPERS"/>
        </preConditions>
        <sql>insert into project_cabinet_papers (project_id, cabinet_papers_id)
            (select id, cabinet_paper_id from project where cabinet_paper_id is not null);
            alter table project drop column cabinet_paper_id;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-691" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="ROLE"/>
        </preConditions>
        <insert tableName="ROLE">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="AUTHORITY" value="ROLE_PMC_USER"/>
        </insert>
        <insert tableName="ROLE">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="AUTHORITY" value="ROLE_PMC_ADMIN"/>
        </insert>
    </changeSet>

    <changeSet id="OCMAKU-731" author="mpostelnicu">
        <sql>update tender set tender_process_id = null where id=87066</sql>
        <sql>update tender set tender_process_id = null where id=50732</sql>
        <sql>update tender set tender_process_id = null where id=64385</sql>
        <sql>update tender set tender_process_id = null where id=96667</sql>

        <sql>update tender_quotation_evaluation set tender_process_id = null where id=91030</sql>
        <sql>update tender_quotation_evaluation set tender_process_id = null where id=91024</sql>
        <sql>update tender_quotation_evaluation set tender_process_id = null where id=95537</sql>
        <sql>update tender_quotation_evaluation set tender_process_id = null where id=95100</sql>

        <sql>update professional_opinion set tender_process_id = null where id = 66733</sql>
        <sql>update professional_opinion set tender_process_id = null where id = 98641</sql>

        <sql>update award_notification set tender_process_id = null where id = 42932</sql>
        <sql>update award_notification set tender_process_id = null where id = 100943</sql>
        <sql>update award_notification set tender_process_id = null where id = 64519</sql>

        <sql>update award_acceptance set tender_process_id = null where id = 103163</sql>
        <sql>update award_acceptance set tender_process_id = null where id = 99745</sql>

        <sql>update contract set tender_process_id = null where id = 51303</sql>
        <sql>update contract set tender_process_id = null where id = 27675</sql>
    </changeSet>

    <changeSet id="OCMAKU-739" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="PLAN_ITEM"/>
            <tableExists tableName="CATEGORY"/>
        </preConditions>
        <sql>
            update plan_item set item_id = (select id from category where dtype='Item' and code='S000000319')
            where id = 20195 and item_id is null
        </sql>
        <sql>
            update plan_item set quantity = 3 where id = 16286 and quantity is null
        </sql>
        <sql>
            delete from category where id = 8672 and dtype='Item' and label is null
        </sql>
        <sql>
            ALTER TABLE category ALTER COLUMN label SET NOT NULL;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-725-sms-alerts" author="Octavian Ciubotaru">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY" />
            <columnExists tableName="CATEGORY" columnName="code" />
        </preConditions>

        <update tableName="CATEGORY">
            <column name="code" value="stalled"/>
            <where>dtype='MEStatus' and label='Stalled'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="code" value="delayed"/>
            <where>dtype='MEStatus' and label='Delayed'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="code" value="completedNotInUse"/>
            <where>dtype='MEStatus' and label='Completed not in use'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="code" value="completeInUse"/>
            <where>dtype='MEStatus' and label='Complete in use'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="code" value="ongoing"/>
            <where>dtype='MEStatus' and label='Ongoing'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="code" value="notStarted"/>
            <where>dtype='MEStatus' and label='Not started'</where>
        </update>

        <update tableName="CATEGORY">
            <column name="code" value="atRisk"/>
            <where>dtype='PMCStatus' and label='At Risk'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="code" value="onTrack"/>
            <where>dtype='PMCStatus' and label='On Track'</where>
        </update>
        <update tableName="CATEGORY">
            <column name="code" value="offTrack"/>
            <where>dtype='PMCStatus' and label='Off Track'</where>
        </update>
    </changeSet>

    <changeSet id="OCMAKU-725-sms-alerts-2" author="Octavian Ciubotaru">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="approved_report" />
        </preConditions>
        <sql><![CDATA[
            ALTER TABLE approved_report
            ADD CONSTRAINT non_null_report
            CHECK ((me_report_id IS NULL) != (pmc_report_id IS NULL));
        ]]></sql>
    </changeSet>

    <changeSet id="OCMAKU-727-rename" author="Octavian Ciubotaru">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="CATEGORY"/>
        </preConditions>

        <update tableName="CATEGORY">
            <column name="label" value="Completed to scope"/>
            <where>dtype='MEStatus' and label='Completed not in use'</where>
        </update>
    </changeSet>

    <changeSet id="OCMAKU-776-covid-remove-roads" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="tender"/>
            <tableExists tableName="tender_process"/>
            <tableExists tableName="project"/>
            <tableExists tableName="procurement_plan"/>
            <tableExists tableName="category"/>
        </preConditions>
        <sql>update tender set procurement_method_rationale_id = null where
            procurement_method_rationale_id = (select id from category where label='COVID-19' and
            dtype='ProcurementMethodRationale') and id in (select t.id from tender t, tender_process tp, project p,
            procurement_plan pp, category c
            where t.tender_process_id=tp.id and tp.project_id = p.id and p.procurement_plan_id=pp.id and
            pp.department_id =c.id and c.dtype='Department' and c.label='Roads, Transport, Energy and Public Works')
        </sql>

    </changeSet>

    <changeSet id="OCMAKU-770" author="mpostelnicu">
        <addNotNullConstraint tableName="administrator_report" columnName="status"/>
        <addNotNullConstraint tableName="award_acceptance" columnName="status"/>
        <addNotNullConstraint tableName="award_notification" columnName="status"/>
        <addNotNullConstraint tableName="cabinet_paper" columnName="status"/>
        <addNotNullConstraint tableName="contract" columnName="status"/>
        <addNotNullConstraint tableName="inspection_report" columnName="status"/>
        <addNotNullConstraint tableName="mereport" columnName="status"/>
        <addNotNullConstraint tableName="payment_voucher" columnName="status"/>
        <addNotNullConstraint tableName="pmcreport" columnName="status"/>
        <addNotNullConstraint tableName="procurement_plan" columnName="status"/>
        <addNotNullConstraint tableName="professional_opinion" columnName="status"/>
        <addNotNullConstraint tableName="project" columnName="status"/>
        <addNotNullConstraint tableName="tender" columnName="status"/>
        <addNotNullConstraint tableName="tender_process" columnName="status"/>
        <addNotNullConstraint tableName="tender_quotation_evaluation" columnName="status"/>
    </changeSet>
    <changeSet id="OCMAKU-786" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="administrator_report"/>
            <tableExists tableName="pmcreport"/>
            <tableExists tableName="inspection_report"/>
            <tableExists tableName="mereport"/>
            <tableExists tableName="payment_voucher"/>
        </preConditions>

        <sql>update pmcreport as r set contract_id = c.id from contract as c
            where r.tender_process_id =c.tender_process_id and r.contract_id is null;
        </sql>

        <addNotNullConstraint tableName="administrator_report" columnName="contract_id"/>
        <addNotNullConstraint tableName="pmcreport" columnName="contract_id"/>
        <addNotNullConstraint tableName="inspection_report" columnName="contract_id"/>
        <addNotNullConstraint tableName="mereport" columnName="contract_id"/>
        <addNotNullConstraint tableName="payment_voucher" columnName="contract_id"/>

        <addNotNullConstraint tableName="administrator_report" columnName="tender_process_id"/>
        <addNotNullConstraint tableName="pmcreport" columnName="tender_process_id"/>
        <addNotNullConstraint tableName="inspection_report" columnName="tender_process_id"/>
        <addNotNullConstraint tableName="mereport" columnName="tender_process_id"/>
        <addNotNullConstraint tableName="payment_voucher" columnName="tender_process_id"/>
    </changeSet>

    <changeSet id="OCMAKU-785-tp" author="mpostelnicu">
        <sqlFile path="sql/OCMAKU-785-cleanup-tp.sql"/>
    </changeSet>

    <changeSet id="OCMAKU-785-constraints" author="mpostelnicu">
        <addNotNullConstraint tableName="award_acceptance" columnName="tender_process_id"/>
<!--        <addNotNullConstraint tableName="award_acceptance_item" columnName="parent_id"/>-->
        <addNotNullConstraint tableName="award_notification" columnName="tender_process_id"/>
        <!--        <addNotNullConstraint tableName="award_notification_item" columnName="parent_id"/>-->
        <addNotNullConstraint tableName="contract" columnName="tender_process_id"/>
        <addNotNullConstraint tableName="professional_opinion" columnName="tender_process_id"/>
        <addNotNullConstraint tableName="tender" columnName="tender_process_id"/>
        <addNotNullConstraint tableName="tender_quotation_evaluation" columnName="tender_process_id"/>
        <addNotNullConstraint tableName="tender_process" columnName="project_id"/>
        <addNotNullConstraint tableName="project" columnName="procurement_plan_id"/>
        <addNotNullConstraint tableName="cabinet_paper" columnName="procurement_plan_id"/>
        <addNotNullConstraint tableName="person" columnName="username"/>
        <addNotNullConstraint tableName="person" columnName="email"/>
        <addNotNullConstraint tableName="person" columnName="first_name"/>
        <addNotNullConstraint tableName="person" columnName="last_name"/>
        <addNotNullConstraint tableName="person" columnName="password"/>
        <!--        <addNotNullConstraint tableName="bid" columnName="parent_id"/>-->
        <!--        <addNotNullConstraint tableName="contract_document" columnName="parent_id"/>-->
        <addNotNullConstraint tableName="feedback_message" columnName="email"/>
        <addNotNullConstraint tableName="feedback_message" columnName="name"/>
        <addNotNullConstraint tableName="feedback_message" columnName="comment"/>
        <addNotNullConstraint tableName="file_metadata" columnName="content_id"/>
        <addNotNullConstraint tableName="fiscal_year" columnName="name"/>
        <addNotNullConstraint tableName="fiscal_year" columnName="start_date"/>
        <addNotNullConstraint tableName="fiscal_year" columnName="end_date"/>
        <addNotNullConstraint tableName="fiscal_year_budget" columnName="amount_budgeted"/>
        <addNotNullConstraint tableName="fiscal_year_budget" columnName="department_id"/>
        <addNotNullConstraint tableName="fiscal_year_budget" columnName="fiscal_year_id"/>
        <!--        <addNotNullConstraint tableName="plan_item" columnName="parent_id"/>-->
        <!--        <addNotNullConstraint tableName="pmcmember" columnName="parent_id"/>-->
        <!--        <addNotNullConstraint tableName="pmcnotes" columnName="parent_id"/>-->
        <!--        <addNotNullConstraint tableName="private_sector_request" columnName="parent_id"/>-->
        <addNotNullConstraint tableName="procurement_plan" columnName="department_id"/>
        <addNotNullConstraint tableName="procurement_plan" columnName="fiscal_year_id"/>
        <addNotNullConstraint tableName="professional_opinion_item" columnName="parent_id"/>
        <!--        <addNotNullConstraint tableName="purch_requisition" columnName="parent_id"/>-->
        <!--        <addNotNullConstraint tableName="purchase_item" columnName="parent_id"/>-->
        <addNotNullConstraint tableName="status_changed_comment" columnName="status"/>
        <!--        <addNotNullConstraint tableName="tender_item" columnName="parent_id"/>-->
        <addNotNullConstraint tableName="tender_process" columnName="project_id"/>
    </changeSet>

    <changeSet id="OCMAKU-814-remove-projects" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <columnExists tableName="tender_process" columnName="procurement_plan_id"/>
        </preConditions>
        <sql>
            update tender_process set procurement_plan_id = project.procurement_plan_id from project
            where tender_process.project_id = project.id;
        </sql>
        <sql>
            alter table tender_process alter column project_id drop not null;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-814-remove-projects-2" author="Octavian Ciubotaru">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="professional_opinion_item" />
        </preConditions>
        <sql>
            alter table professional_opinion_item alter column parent_id drop not null;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-824-remove-purchase-reqs-1" author="mpostelnicu">
        <sql>alter table purch_requisition rename column parent_id to old_parent_id</sql>
    </changeSet>

    <changeSet id="OCMAKU-824-remove-purchase-reqs-2" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="purchase_requisition_group"/>
        </preConditions>
        <sql>insert into purchase_requisition_group (id, tender_process_id,
            created_by, created_date, last_modified_by, last_modified_date, status, approved_date,
            purchase_request_number) (select nextval('hibernate_sequence'), id,
            created_by, created_date, last_modified_by, last_modified_date, status, approved_date,
            purchase_request_number from tender_process);
        </sql>
        <sql>
            update purch_requisition set parent_id = purchase_requisition_group.id
            from purchase_requisition_group where purch_requisition.old_parent_id=
            purchase_requisition_group.tender_process_id;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-824-remove-purchase-reqs-3" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="purchase_requisition_group"/>
        </preConditions>
        <addNotNullConstraint tableName="purchase_requisition_group" columnName="tender_process_id"/>
        <sql>alter table tender_process alter column status drop not null;</sql>
        <sql>alter table tender_process alter column procurement_plan_id set not null;</sql>
    </changeSet>

    <changeSet id="OCMAKU-842" author="Octavian Ciubotaru">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Satisfactory"/>
            <column name="DTYPE" value="InspectionReportOutcome"/>
        </insert>
        <insert tableName="CATEGORY">
            <column name="ID" valueComputed="nextval('hibernate_sequence')"/>
            <column name="LABEL" value="Unsatisfactory"/>
            <column name="DTYPE" value="InspectionReportOutcome"/>
        </insert>
    </changeSet>
    <changeSet id="OCMAKU-896" author="mpostelnicu">
        <preConditions onFail="CONTINUE">
            <foreignKeyConstraintExists foreignKeyName="fk1thmycnkpijd9t97s05q88ohy"/>
        </preConditions>
        <sql>
            alter table contract drop constraint fk1thmycnkpijd9t97s05q88ohy;
        </sql>
    </changeSet>

    <changeSet id="OCMAKU-874" author="Octavian Ciubotaru">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="category"/>
        </preConditions>
        <sql><![CDATA[
            UPDATE category
            SET code=REPLACE(REPLACE(code, CHR(10), ' '), CHR(13), '')
            WHERE dtype = 'Item'
              AND STRPOS(code, CHR(10)) > 0;

            UPDATE category
            SET label=REPLACE(REPLACE(label, CHR(10), ' '), CHR(13), '')
            WHERE dtype = 'Item'
              AND STRPOS(label, CHR(10)) > 0;
        ]]></sql>
    </changeSet>
</databaseChangeLog>
